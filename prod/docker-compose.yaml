networks:
  appnet:
    external: true
    name: marc_appnet

x-log-options: &marc-log-options
  driver: k8s-file
  options: &marc-log-driver-options
    max_size: 10m
    max_file: 5

x-marc-web-base: &marc-web-base
  restart: unless-stopped
  volumes:
    - ${MARC_LOCAL_DB_PATH}:/data:ro
  environment:
    MARC_DB_URL: sqlite:////data/marc.sqlite?mode=ro&immutable=1
    MARC_DB_LAST_SYNC: /data/last_sync.txt
    MODEL: ${OPENAI_MODEL}
    OPENAI_API_KEY: ${OPENAI_API_KEY}
  healthcheck:
    test:
      [
        "CMD",
        "python",
        "-c",
        "import urllib.request,sys;sys.exit(0 if urllib.request.urlopen('http://localhost:8080/health').getcode()<400 else 1)",
      ]
    interval: 30s
    timeout: 5s
    retries: 3

x-marc-web-prod: &marc-web-prod
  <<: *marc-web-base
  image: ${MARC_PROD_IMAGE:?MARC_PROD_IMAGE is required}

services:
  marc-web-prod:
    <<: *marc-web-prod
    container_name: marc-web-${MARC_PROD_POOL:?MARC_PROD_POOL is required}
    networks:
      appnet:
        aliases:
          - marc-web-${MARC_PROD_POOL:?MARC_PROD_POOL is required}
    logging:
      <<: *marc-log-options
      options:
        <<: *marc-log-driver-options
        path: /var/log/marc/marc-web-${MARC_PROD_POOL:?MARC_PROD_POOL is required}.log
